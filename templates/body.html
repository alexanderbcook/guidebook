<div id="recommendation-grid" style="visibility:visible">
  <div class="row row-cols-auto">
   {% for r in recommendations %} 
   <div class="col">
      <!-- Card -->
      {% if r.fields.POTM == '1' %}
      <button class="card" id="potm" data-bs-toggle="modal" data-bs-target="#{{r.id}}" hx-target="#{{r.id}}" hx-get="/recommendation/{{r.id}}">
      {% else %}
      <button class="card" id="{{r.fields.Categories[0].lower()}}"data-bs-toggle="modal" data-bs-target="#{{r.id}}" hx-target="#{{r.id}}" hx-get="/recommendation/{{r.id}}">
      {% endif %}
        <div class="card-body">
          {% if r.fields.POTM == '1' %}
          <h4 class="card-title" id="card-title">{{r.fields.Name}}</h4>
          <h6 class="card-title" id="card-title"><i>Pick of the Moment!</i></h6>
          {% else %}
          <h5 class="card-title" id="card-title">{{r.fields.Name}}</h5>
          {% endif %}
          <p class="card-text" id="desktop-text">        
            {% if r.fields.Description|length < 150 %}
            {{ r.fields.Description }}
            {% else %}
            {{ r.fields.Description|truncate(150, False, '...')}}
            {% endif %}
          </p>
          <p class="card-text" id="mobile-text">        
            {% if r.fields.Description|length < 75 %}
            {{ r.fields.Description }}
            {% else %}
            {{ r.fields.Description|truncate(75, False, '...')}}
            {% endif %}
          </p>
          <hr/>
          {% if 'Tags' in r.fields %}
          <p>
            <i>{% for t in r.fields.Tags %}
                {{t.lower() | trim}}&nbsp
              {% endfor %}
            </i>
          </p>
          {% endif %}
        </div>
      </button>
      <!-- Modal -->
      <div class="modal fade" id="{{r.id}}" tabindex="-1" aria-hidden="true">
        {% include 'modal.html' %}
      </div>
    </div>
   {% endfor %}
  </div></div>  
<div id='map-container' data-tap-disabled="true" style="visibility:collapse">
  <div id='map' style='width:100%; height:75vh; margin:0;'></div>
</div>


<script>

    var recommendations = {{recommendations | tojson | safe }}

    mapboxgl.accessToken = 'pk.eyJ1IjoiYWJjb29rIiwiYSI6ImNqcnp5N3N2ZzFkeWs0NG80bnVtNmFxaDEifQ.zPkUuVuuVNGg-3DkQcBflQ';

    var map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/streets-v12',
        center: [-122.6355, 45.535],
        zoom: 10,
        interactive: false

    });

    var markers = []

    var mapboxClient = mapboxSdk({ accessToken: mapboxgl.accessToken });

    recommendations.forEach(recommendation => {
      var markerColor = '#e87166'
      var popupHTML = "<h6><b>Name:</b> "+recommendation.fields.Name+"</h6><br><h6><b>Address:</b> "+recommendation.fields.Address

      if(!isNaN(recommendation.fields.lng)){
        var coords = [recommendation.fields.lng, recommendation.fields.lat]
          var marker = new mapboxgl.Marker({ "color": markerColor })
            .setLngLat(coords)
            .setPopup(new mapboxgl.Popup({"closeButton":false}).setHTML( popupHTML))
            .addTo(map);

        var markerDiv = marker.getElement();
 
        markerDiv.addEventListener('mouseenter', () => marker.togglePopup());
        markerDiv.addEventListener('mouseleave', () => marker.togglePopup());
        markerDiv.addEventListener('click', () =>   window.open(recommendation.fields.MapLink, '_blank').focus());
      }
    });     

    </script>
    <style>
    .leaflet-clickable {
       cursor: pointer;
    }
    .mapboxgl-popup-content{
        font: 7px sans-serif;
        padding: 7.5px;
        width: 275px;
    }
    .mapbox-popup-content-wrapper {
        padding: 5%;
    }
    -webkit-touch-callout: none;
    -webkit-user-select: none;
    </style>